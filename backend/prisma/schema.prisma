// Prisma Schema para Sistema de Reclamos Telco
// Database: SQLite (desarrollo) / PostgreSQL (producción)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELOS PRINCIPALES
// ============================================

model Usuario {
  id                    String    @id @default(uuid())
  email                 String    @unique
  password_hash         String
  nombre                String
  apellido              String
  telefono              String?
  avatar_url            String?

  // Rol: PROFESIONAL, TECNICO, SUPERVISOR, ADMINISTRADOR
  rol                   String
  activo                Boolean   @default(true)
  email_verificado      Boolean   @default(false)

  // MFA (Multi-Factor Authentication)
  mfa_habilitado        Boolean   @default(false)
  mfa_secret            String?

  // Notificaciones
  telegram_chat_id      String?
  onesignal_player_id   String?

  // Preferencias de notificación (JSON string)
  preferencias_notif    String?

  // Configuración regional
  zona_horaria          String    @default("America/Argentina/Buenos_Aires")
  idioma                String    @default("es")

  // Seguridad
  intentos_fallidos     Int       @default(0)
  bloqueado_hasta       DateTime?
  ultimo_login          DateTime?
  ultimo_cambio_pass    DateTime?

  // Relaciones
  refresh_tokens        RefreshToken[]
  reclamos_creados      Reclamo[] @relation("ReclamosProfesional")
  reclamos_asignados    Reclamo[] @relation("ReclamosTecnico")
  notificaciones        Notificacion[]
  auditorias            AuditoriaReclamo[]
  comentarios           Comentario[]
  archivos_subidos      Archivo[] @relation("ArchivoSubidoPor")
  sesiones              Sesion[]

  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  deleted_at            DateTime? // Soft delete

  @@index([email])
  @@index([rol])
  @@index([activo])
  @@map("usuarios")
}

model RefreshToken {
  id              String   @id @default(uuid())
  token           String   @unique
  usuario_id      String
  usuario         Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  expires_at      DateTime
  revocado        Boolean  @default(false)
  revocado_at     DateTime?
  ip_address      String?
  user_agent      String?

  created_at      DateTime @default(now())

  @@index([usuario_id])
  @@index([token])
  @@index([expires_at])
  @@map("refresh_tokens")
}

model Sesion {
  id              String   @id @default(uuid())
  usuario_id      String
  usuario         Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  token           String   @unique
  ip_address      String
  user_agent      String
  dispositivo     String?
  ubicacion       String?

  activa          Boolean  @default(true)
  ultimo_acceso   DateTime @default(now())
  expires_at      DateTime

  created_at      DateTime @default(now())

  @@index([usuario_id])
  @@index([activa])
  @@map("sesiones")
}

model Reclamo {
  id                      String           @id @default(uuid())
  numero_reclamo          String           @unique // RCL-2024-00001

  titulo                  String
  descripcion             String

  // Estado: ABIERTO, ASIGNADO, EN_CURSO, EN_REVISION, CERRADO, RECHAZADO
  estado                  String           @default("ABIERTO")
  // Prioridad: BAJA, MEDIA, ALTA, URGENTE
  prioridad               String           @default("MEDIA")

  // Categoría: INTERNET_ADSL, INTERNET_FIBRA, TELEFONO_ADSL, TELEFONO_FIBRA, TV_SENSA
  categoria               String
  subcategoria            String?

  // Ubicación del problema
  direccion               String?
  latitud                 Float?
  longitud                Float?

  // Relaciones - Profesional que crea el reclamo
  id_profesional          String
  profesional             Usuario          @relation("ReclamosProfesional", fields: [id_profesional], references: [id])

  // Técnico asignado (puede ser null si no está asignado aún)
  id_tecnico_asignado     String?
  tecnico_asignado        Usuario?         @relation("ReclamosTecnico", fields: [id_tecnico_asignado], references: [id])

  // Fechas importantes del ciclo de vida
  fecha_creacion          DateTime         @default(now())
  fecha_asignacion        DateTime?
  fecha_inicio_trabajo    DateTime?
  fecha_resolucion        DateTime?
  fecha_cierre            DateTime?

  // SLA (Service Level Agreement)
  sla_respuesta_horas     Int              @default(24)  // Tiempo para primera respuesta
  sla_resolucion_horas    Int              @default(72)  // Tiempo para resolución
  sla_vencimiento         DateTime?
  sla_cumplido            Boolean?

  // Resolución
  notas_resolucion        String?
  calificacion            Int?             // 1-5 estrellas
  comentario_calificacion String?

  // Metadata adicional (JSON string)
  metadata                String?

  // Relaciones
  notificaciones          Notificacion[]
  auditorias              AuditoriaReclamo[]
  comentarios             Comentario[]
  archivos                Archivo[]

  created_at              DateTime         @default(now())
  updated_at              DateTime         @updatedAt
  deleted_at              DateTime?        // Soft delete

  @@index([estado])
  @@index([prioridad])
  @@index([categoria])
  @@index([id_profesional])
  @@index([id_tecnico_asignado])
  @@index([fecha_creacion])
  @@index([sla_vencimiento])
  @@index([numero_reclamo])
  @@map("reclamos")
}

model Comentario {
  id              String   @id @default(uuid())
  reclamo_id      String
  reclamo         Reclamo  @relation(fields: [reclamo_id], references: [id], onDelete: Cascade)

  usuario_id      String
  usuario         Usuario  @relation(fields: [usuario_id], references: [id])

  contenido       String
  interno         Boolean  @default(false) // Si es interno (solo visible para técnicos/admins)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([reclamo_id])
  @@index([usuario_id])
  @@index([created_at])
  @@map("comentarios")
}

model Archivo {
  id                String   @id @default(uuid())
  reclamo_id        String
  reclamo           Reclamo  @relation(fields: [reclamo_id], references: [id], onDelete: Cascade)

  subido_por_id     String
  subido_por        Usuario  @relation("ArchivoSubidoPor", fields: [subido_por_id], references: [id])

  nombre_original   String
  nombre_almacenado String
  ruta              String
  mime_type         String
  tamanio_bytes     Int

  hash_sha256       String   // Para verificar integridad

  // Metadata de imagen (si aplica)
  ancho             Int?
  alto              Int?

  created_at        DateTime @default(now())

  @@index([reclamo_id])
  @@index([subido_por_id])
  @@map("archivos")
}

model Notificacion {
  id                String              @id @default(uuid())
  usuario_id        String
  usuario           Usuario             @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  reclamo_id        String?
  reclamo           Reclamo?            @relation(fields: [reclamo_id], references: [id], onDelete: SetNull)

  // Tipo: EMAIL, TELEGRAM, PUSH, SMS
  tipo              String
  // Estado: PENDIENTE, ENVIADA, FALLIDA, ENTREGADA, LEIDA
  estado            String              @default("PENDIENTE")

  titulo            String
  mensaje           String

  // Datos específicos por canal (JSON string)
  datos_envio       String?

  // Tracking
  intentos_envio    Int                 @default(0)
  enviada_at        DateTime?
  entregada_at      DateTime?
  leida_at          DateTime?
  error_mensaje     String?

  // Metadata (JSON string)
  metadata          String?

  created_at        DateTime            @default(now())

  @@index([usuario_id])
  @@index([reclamo_id])
  @@index([tipo])
  @@index([estado])
  @@index([created_at])
  @@map("notificaciones")
}

model AuditoriaReclamo {
  id                String   @id @default(uuid())
  reclamo_id        String
  reclamo           Reclamo  @relation(fields: [reclamo_id], references: [id], onDelete: Cascade)

  usuario_id        String
  usuario           Usuario  @relation(fields: [usuario_id], references: [id])

  accion            String   // 'CREADO', 'ASIGNADO', 'ESTADO_CAMBIADO', etc.

  estado_anterior   String?
  estado_nuevo      String?

  // Campos cambiados (JSON string)
  campos_cambiados  String?
  notas             String?

  ip_address        String?
  user_agent        String?

  created_at        DateTime @default(now())

  @@index([reclamo_id])
  @@index([usuario_id])
  @@index([created_at])
  @@map("auditorias_reclamo")
}

// ============================================
// CONFIGURACIÓN DEL SISTEMA
// ============================================

model Configuracion {
  clave             String   @id
  valor             String
  descripcion       String?
  tipo              String   // 'string', 'number', 'boolean', 'json'

  updated_at        DateTime @updatedAt

  @@map("configuraciones")
}

model PlantillaNotificacion {
  id                String            @id @default(uuid())
  codigo            String            @unique
  nombre            String
  tipo              String // EMAIL, TELEGRAM, PUSH, SMS

  asunto            String?           // Para emails
  contenido         String

  // Variables disponibles (JSON string): {{nombre_usuario}}, {{numero_reclamo}}, etc.
  variables         String

  activa            Boolean           @default(true)

  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  @@map("plantillas_notificacion")
}
